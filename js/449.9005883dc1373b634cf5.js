"use strict";(self.webpackChunkbabylonjs_typescript_webpack_template=self.webpackChunkbabylonjs_typescript_webpack_template||[]).push([[449,900],{7449:(e,t,r)=>{r.r(t),r.d(t,{_ENVTextureLoader:()=>x});var n=r(66),a=r(4983),i=r(9111),o=r(7369),s=r(7565),l=r(7766),c=(r(167),r(1015)),u=r(461);r(4197),r(9900);var p=r(9783);l.t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(l.t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=p.d.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});const d="image/png",h=[134,22,135,150,246,214,150,54];function m(e){if(e.version>2)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:d}}function f(e,t,r){const n=(r=m(r)).specular;if(!n)return Promise.resolve([]);e._lodGenerationScale=n.lodGenerationScale;const a=[],i=function(e,t){const r=(t=m(t)).specular;let n=Math.log2(t.width);if(n=Math.round(n)+1,r.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const a=new Array(n);for(let i=0;i<n;i++){a[i]=new Array(6);for(let n=0;n<6;n++){const o=r.mipmaps[6*i+n];a[i][n]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+o.position,o.length)}}return a}(t,r);a.push(async function(e,t,r=d){const n=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),await y(e,t,!0,r),e.isReady=!0}(e,i,r.imageType));const o=r.irradiance?.irradianceTexture;if(o){const n=function(e,t){t=m(t);const r=new Array(6),n=t.irradiance?.irradianceTexture;if(n){if(6!==n.faces.length)throw new Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let a=0;a<6;a++){const i=n.faces[a];r[a]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+i.position,i.length)}}return r}(t,r);a.push(async function(e,t,r,n=d){const a=e.getEngine(),i=new s.h(a,5),o=new l.t(a,i);e._irradianceTexture=o,i.isCube=!0,i.format=5,i.type=0,i.generateMipMaps=!0,i._cachedAnisotropicFilteringLevel=null,i.generateMipMaps=!0,i.width=r,i.height=r,a.updateTextureSamplingMode(3,i),await y(i,[t],!1,n),a.generateMipMapsForCubemap(i),i.isReady=!0}(e,n,o.size,r.imageType))}return Promise.all(a)}function w(e,t,r,n,a,i,o,s,l,c,u){return new Promise(((p,d)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,(e=>{d(e)}),e);n?.onEffectCreatedObservable.addOnce((s=>{s.executeWhenCompiled((()=>{n.externalTextureSamplerBinding=!0,n.onApply=n=>{n._bindTexture("textureSampler",r),n.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([n],c,!0,i,o),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(a),p())}))}))}else{if(t._uploadImageToTexture(u,e,i,o),s){const r=l[o];r&&t._uploadImageToTexture(r._texture,e,i,0)}p()}}))}async function y(e,t,a,o=d){if(!n.S0.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const u=(0,i.C0)(e.width)+1,p=e.getEngine();let h=!1,m=!1,f=null,y=null,x=null;const g=p.getCaps();g.textureLOD?p._features.supportRenderAndCopyToLodForFloatTextures?g.textureHalfFloatRender&&g.textureHalfFloatLinearFiltering?(h=!0,e.type=2):g.textureFloatRender&&g.textureFloatLinearFiltering&&(h=!0,e.type=1):h=!1:(h=!1,m=a);let _=0;if(h)p.isWebGPU?(_=1,await r.e(143).then(r.bind(r,5143))):await r.e(606).then(r.bind(r,8606)),f=new c.w("rgbdDecode","rgbdDecode",null,null,1,null,3,p,!1,void 0,e.type,void 0,null,!1,void 0,_),e._isRGBD=!1,e.invertY=!1,y=p.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,m){const t=3;x={};const r=e._lodGenerationScale,n=e._lodGenerationOffset;for(let a=0;a<t;a++){const i=(u-1)*r+n,o=n+(i-n)*(1-a/(t-1)),c=Math.round(Math.min(Math.max(o,0),i)),d=new s.h(p,2);d.isCube=!0,d.invertY=!0,d.generateMipMaps=!1,p.updateTextureSamplingMode(2,d);const h=new l.t(null);switch(h._isCube=!0,h._texture=d,x[c]=h,a){case 0:e._lodTextureLow=h;break;case 1:e._lodTextureMid=h;break;case 2:e._lodTextureHigh=h}}}const P=[];for(let r=0;r<t.length;r++)for(let n=0;n<6;n++){const a=t[r][n],i=new Blob([a],{type:o}),s=URL.createObjectURL(i);let l;if(p._features.forceBitmapOverHTMLImageElement)l=p.createImageBitmap(i,{premultiplyAlpha:"none"}).then((t=>w(t,p,h,f,s,n,r,m,x,y,e)));else{const t=new Image;t.src=s,l=new Promise(((a,i)=>{t.onload=()=>{w(t,p,h,f,s,n,r,m,x,y,e).then((()=>a())).catch((e=>{i(e)}))},t.onerror=e=>{i(e)}}))}P.push(l)}if(await Promise.all(P),t.length<u){let r;const n=Math.pow(2,u-1-t.length),a=n*n*4;switch(e.type){case 0:r=new Uint8Array(a);break;case 2:r=new Uint16Array(a);break;case 1:r=new Float32Array(a)}for(let n=t.length;n<u;n++)for(let t=0;t<6;t++)p._uploadArrayBufferViewToTexture(y?.texture||e,r,t,n)}if(y){const t=e._irradianceTexture;e._irradianceTexture=null,p._releaseTexture(e),y._swapAndDie(e),e._irradianceTexture=t}f&&f.dispose(),m&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}class x{constructor(){this.supportCascades=!1}loadCubeData(e,t,r,n,i){if(Array.isArray(e))return;const s=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let e=0;e<h.length;e++)if(t.getUint8(r++)!==h[e])return u.V.Error("Not a babylon environment map"),null;let n="",a=0;for(;a=t.getUint8(r++);)n+=String.fromCharCode(a);let i=JSON.parse(n);return i=m(i),i.binaryDataPosition=r,i.specular&&(i.specular.lodGenerationScale=i.specular.lodGenerationScale||.8),i}(e);if(s){t.width=s.width,t.height=s.width;try{(function(e,t){const r=(t=m(t)).irradiance;if(!r)return;const n=new o.Q;a.Pq.FromArrayToRef(r.x,0,n.x),a.Pq.FromArrayToRef(r.y,0,n.y),a.Pq.FromArrayToRef(r.z,0,n.z),a.Pq.FromArrayToRef(r.xx,0,n.xx),a.Pq.FromArrayToRef(r.yy,0,n.yy),a.Pq.FromArrayToRef(r.zz,0,n.zz),a.Pq.FromArrayToRef(r.yz,0,n.yz),a.Pq.FromArrayToRef(r.zx,0,n.zx),a.Pq.FromArrayToRef(r.xy,0,n.xy),e._sphericalPolynomial=n})(t,s),f(t,e,s).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}),(e=>{i?.("Can not upload environment levels",e)}))}catch(e){i?.("Can not upload environment file",e)}}else i&&i("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}},9783:(e,t,r)=>{r.d(t,{d:()=>c});var n=r(4983),a=r(9111),i=r(7369),o=r(507),s=r(9341);class l{constructor(e,t,r,n){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=r,this.worldAxisForFileY=n}}class c{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();const t=e.getSize().width,r=e.readPixels(0,void 0,void 0,!1),n=e.readPixels(1,void 0,void 0,!1);let a,i;e.isRenderTarget?(a=e.readPixels(3,void 0,void 0,!1),i=e.readPixels(2,void 0,void 0,!1)):(a=e.readPixels(2,void 0,void 0,!1),i=e.readPixels(3,void 0,void 0,!1));const o=e.readPixels(4,void 0,void 0,!1),s=e.readPixels(5,void 0,void 0,!1),l=e.gammaSpace;let c=0;return 1!=e.textureType&&2!=e.textureType||(c=1),new Promise((e=>{Promise.all([n,r,a,i,o,s]).then((([r,n,a,i,o,s])=>{const u={size:t,right:n,left:r,up:a,down:i,front:o,back:s,format:5,type:c,gammaSpace:l};e(this.ConvertCubeMapToSphericalPolynomial(u))}))}))}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new i.O;let r=0;const n=2/e.size,l=n,c=.5*n,u=c-1;for(let i=0;i<6;i++){const p=this._FileFaces[i],d=e[p.name];let h=u;const m=5===e.format?4:3;for(let i=0;i<e.size;i++){let f=u;for(let l=0;l<e.size;l++){const u=p.worldAxisForFileX.scale(f).add(p.worldAxisForFileY.scale(h)).add(p.worldAxisForNormal);u.normalize();const w=this._AreaElement(f-c,h-c)-this._AreaElement(f-c,h+c)-this._AreaElement(f+c,h-c)+this._AreaElement(f+c,h+c);let y=d[i*e.size*m+l*m+0],x=d[i*e.size*m+l*m+1],g=d[i*e.size*m+l*m+2];isNaN(y)&&(y=0),isNaN(x)&&(x=0),isNaN(g)&&(g=0),0===e.type&&(y/=255,x/=255,g/=255),e.gammaSpace&&(y=Math.pow((0,a.OQ)(y),o.tk),x=Math.pow((0,a.OQ)(x),o.tk),g=Math.pow((0,a.OQ)(g),o.tk));const _=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const e=Math.max(y,x,g);if(e>_){const t=_/e;y*=t,x*=t,g*=t}}else y=(0,a.OQ)(y,0,_),x=(0,a.OQ)(x,0,_),g=(0,a.OQ)(g,0,_);const P=new s.v9(y,x,g);t.addLight(u,P,w),r+=w,f+=n}h+=l}}const p=4*Math.PI*6/6/r;return t.scaleInPlace(p),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),i.Q.FromHarmonics(t)}}c._FileFaces=[new l("right",new n.Pq(1,0,0),new n.Pq(0,0,-1),new n.Pq(0,-1,0)),new l("left",new n.Pq(-1,0,0),new n.Pq(0,0,1),new n.Pq(0,-1,0)),new l("up",new n.Pq(0,1,0),new n.Pq(1,0,0),new n.Pq(0,0,1)),new l("down",new n.Pq(0,-1,0),new n.Pq(1,0,0),new n.Pq(0,0,-1)),new l("front",new n.Pq(0,0,1),new n.Pq(1,0,0),new n.Pq(0,-1,0)),new l("back",new n.Pq(0,0,-1),new n.Pq(-1,0,0),new n.Pq(0,-1,0))],c.MAX_HDRI_VALUE=4096,c.PRESERVE_CLAMPED_COLORS=!1},9900:(e,t,r)=>{r.r(t),r.d(t,{Dispose:()=>d,DumpData:()=>p,DumpDataAsync:()=>u,DumpFramebuffer:()=>c,DumpTools:()=>h});var n=r(3155),a=r(66),i=r(9111),o=r(9583);let s,l=null;async function c(e,t,r,n,a="image/png",i,o){const s=await r.readPixels(0,0,e,t);p(e,t,new Uint8Array(s.buffer),n,a,i,!0,void 0,o)}function u(e,t,r,n="image/png",a,i=!1,o=!1,s){return new Promise((l=>{p(e,t,r,(e=>l(e)),n,a,i,o,s)}))}function p(e,t,c,u,p="image/png",h,m=!1,f=!1,w){(async function(){return l||(l=new Promise(((e,t)=>{let a,i=null;const l={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};Promise.resolve().then(r.bind(r,1371)).then((({ThinEngine:c})=>{const u=o.q.Instances.length;try{a=new OffscreenCanvas(100,100),i=new c(a,!1,l)}catch(e){u<o.q.Instances.length&&o.q.Instances.pop()?.dispose(),a=document.createElement("canvas"),i=new c(a,!1,l)}o.q.Instances.pop(),o.q.OnEnginesDisposedObservable.add((e=>{i&&e!==i&&!i.isDisposed&&0===o.q.Instances.length&&d()})),i.getCaps().parallelShaderCompile=void 0;const p=new n.J(i);r.e(752).then(r.bind(r,8752)).then((({passPixelShader:r})=>{if(!i)return void t("Engine is not defined");const o=new n.$({engine:i,name:r.name,fragmentShader:r.shader,samplerNames:["textureSampler"]});s={canvas:a,engine:i,renderer:p,wrapper:o},e(s)}))})).catch(t)}))),await l})().then((r=>{if(r.engine.setSize(e,t,!0),c instanceof Float32Array){const e=new Uint8Array(c.length);let t=c.length;for(;t--;){const r=c[t];e[t]=Math.round(255*(0,i.OQ)(r))}c=e}const n=r.engine.createRawTexture(c,e,t,5,!1,!m,1);r.renderer.setViewport(),r.renderer.applyEffectWrapper(r.wrapper),r.wrapper.effect._bindTexture("textureSampler",n),r.renderer.draw(),f?a.S0.ToBlob(r.canvas,(e=>{const t=new FileReader;t.onload=e=>{const t=e.target.result;u&&u(t)},t.readAsArrayBuffer(e)}),p,w):a.S0.EncodeScreenshotCanvasData(r.canvas,u,p,h,w),n.dispose()}))}function d(){s?(s.wrapper.dispose(),s.renderer.dispose(),s.engine.dispose()):l?.then((e=>{e.wrapper.dispose(),e.renderer.dispose(),e.engine.dispose()})),l=null,s=null}const h={DumpData:p,DumpDataAsync:u,DumpFramebuffer:c,Dispose:d};a.S0.DumpData=p,a.S0.DumpDataAsync=u,a.S0.DumpFramebuffer=c}}]);
//# sourceMappingURL=449.9005883dc1373b634cf5.js.map