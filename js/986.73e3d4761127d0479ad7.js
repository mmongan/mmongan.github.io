"use strict";(self.webpackChunkbabylonjs_typescript_webpack_template=self.webpackChunkbabylonjs_typescript_webpack_template||[]).push([[986],{5986:(e,t,r)=>{r(2038);var i=r(461),s=r(6740),n=r(8474),o=r(3469),p=r(3862),u=r(3288);class a{constructor(e,t,r,i=""){let u;this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new s.cP,this.onErrorObservable=new s.cP,this.onBindObservable=new s.cP,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=1,this.name=e,this._key=i,this._engine=r,this.uniqueId=a._UniqueIdSeed++,this.defines=t.defines??"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=t.entryPoint??"main",this._shaderStore=p.l.GetShadersStore(this._shaderLanguage),this._shaderRepository=p.l.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=p.l.GetIncludesShadersStore(this._shaderLanguage);const h=(0,n.BA)()?this._engine.getHostDocument():null;u="string"==typeof e?e:e.computeSource?"source:"+e.computeSource:e.computeElement?h?.getElementById(e.computeElement)||e.computeElement:e.compute||e;const c={defines:this.defines.split("\n"),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:(e,t,r)=>{if(!r)return t;for(const e of r){const r=e.replace("#define","").replace(";","").trim().split(" ");if(2===r.length){const e=r[0],i=r[1];isNaN(parseInt(i))&&isNaN(parseFloat(i))||(t=`const ${e} = ${i};\n`+t)}}return t}};this._loadShader(u,"Compute","",(r=>{(0,o.pB)(c),(0,o.jC)(r,c,(i=>{this._rawComputeSourceCode=r,t.processFinalCode&&(i=t.processFinalCode(i));const s=(0,o.nO)(i,"",c);this._useFinalCode(s.vertexCode,e)}),this._engine)}))}_useFinalCode(e,t){if(t){const r=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+r+"\n"+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||this._checkIsReady(null))}_checkIsReady(e){(0,u.F)((()=>this._isReadyInternal()),(()=>{}),(t=>{this._processCompilationErrors(t,e)}),void 0,void 0,!1)}_loadShader(e,t,r,i){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return void i((0,n.Zl)(e));if("source:"===e.substring(0,7))return void i(e.substring(7));if("base64:"===e.substring(0,7))return void i(window.atob(e.substring(7)));if(this._shaderStore[e+t+"Shader"])return void i(this._shaderStore[e+t+"Shader"]);if(r&&this._shaderStore[e+r+"Shader"])return void i(this._shaderStore[e+r+"Shader"]);let s;s="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:this._shaderRepository+e,this._engine._loadFile(s+"."+t.toLowerCase()+".fx",i)}get computeSourceCode(){return this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._pipelineContext?._getComputeShaderCode()??this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const e=this.defines,t=this._pipelineContext;this._isReady=!1;try{const r=this._engine;this._pipelineContext=r.createComputePipelineContext(),this._pipelineContext._name=this._key,r._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),r._executeWhenComputeStateIsCompiled(this._pipelineContext,(e=>{e&&e.numErrors>0?this._processCompilationErrors(e,t):(this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t))})),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(e){this._processCompilationErrors(e,t)}}_processCompilationErrors(e,t=null){if(this._compilationError="",i.V.Error("Unable to compile compute effect:"),this.defines&&i.V.Error("Defines:\n"+this.defines),a.LogShaderCodeOnCompilationError){const e=this._pipelineContext?._getComputeShaderCode();e&&(i.V.Error("Compute code:"),i.V.Error(e))}if("string"==typeof e)this._compilationError=e,i.V.Error("Error: "+this._compilationError);else for(const t of e.messages){let e="";void 0!==t.line&&(e+="Line "+t.line+", "),void 0!==t.offset&&(e+="Offset "+t.offset+", "),void 0!==t.length&&(e+="Length "+t.length+", "),e+=t.type+": "+t.text,this._compilationError&&(this._compilationError+="\n"),this._compilationError+=e,i.V.Error(e)}t&&(this._pipelineContext=t,this._isReady=!0),this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){p.l.GetShadersStore(1)[`${e}ComputeShader`]=t}}a._UniqueIdSeed=0,a.LogShaderCodeOnCompilationError=!0;var h=r(421);class c{getBindGroups(e,t,r){if(!r)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){const s=this._bindGroupEntries.length>0;for(const t in e){const n=e[t],o=r[t],p=o.group,u=o.binding,a=n.type,h=n.object;let c=n.indexInGroupEntries,d=this._bindGroupEntries[p];switch(d||(d=this._bindGroupEntries[p]=[]),a){case 5:{const e=h;void 0!==c&&s?d[c].resource=this._cacheSampler.getSampler(e):(n.indexInGroupEntries=d.length,d.push({binding:u,resource:this._cacheSampler.getSampler(e)}));break}case 0:case 4:{const e=h,t=e._texture._hardwareTexture;void 0!==c&&s?(0===a&&(d[c++].resource=this._cacheSampler.getSampler(e._texture)),d[c].resource=t.view):(n.indexInGroupEntries=d.length,0===a&&d.push({binding:u-1,resource:this._cacheSampler.getSampler(e._texture)}),d.push({binding:u,resource:t.view}));break}case 1:{const e=h,t=e._texture._hardwareTexture;8&t.textureAdditionalUsages||i.V.Error(`computeDispatch: The texture (name=${e.name}, uniqueId=${e.uniqueId}) is not a storage texture!`,50),void 0!==c&&s?d[c].resource=t.viewForWriting:(n.indexInGroupEntries=d.length,d.push({binding:u,resource:t.viewForWriting}));break}case 6:{const e=h.underlyingResource;void 0!==c&&s?d[c].resource=this._device.importExternalTexture({source:e}):(n.indexInGroupEntries=d.length,d.push({binding:u,resource:this._device.importExternalTexture({source:e})}));break}case 2:case 3:case 7:{const e=7===a?h:h.getBuffer(),t=e.underlyingResource;void 0!==c&&s?(d[c].resource.buffer=t,d[c].resource.size=e.capacity):(n.indexInGroupEntries=d.length,d.push({binding:u,resource:{buffer:t,offset:0,size:e.capacity}}));break}}}for(let e=0;e<this._bindGroupEntries.length;++e){const r=this._bindGroupEntries[e];this._bindGroups[e]=r?this._device.createBindGroup({layout:t.getBindGroupLayout(e),entries:r}):void 0}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=c._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}c._Counter=0;class d{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){return this.sources?.compute}dispose(){}}const l={};h.$.prototype.createComputeContext=function(){return new c(this._device,this._cacheSampler)},h.$.prototype.createComputeEffect=function(e,t){const r=("string"==typeof e?e:e.computeToken||e.computeSource||e.computeElement||e.compute)+"@"+t.defines;if(this._compiledComputeEffects[r]){const e=this._compiledComputeEffects[r];return t.onCompiled&&e.isReady()&&t.onCompiled(e),e}const i=new a(e,t,this,r);return this._compiledComputeEffects[r]=i,i},h.$.prototype.createComputePipelineContext=function(){return new d(this)},h.$.prototype.areAllComputeEffectsReady=function(){for(const e in this._compiledComputeEffects)if(!this._compiledComputeEffects[e].isReady())return!1;return!0},h.$.prototype.computeDispatch=function(e,t,r,i,s=1,n=1,o,p){this._computeDispatch(e,t,r,i,s,n,void 0,void 0,o,p)},h.$.prototype.computeDispatchIndirect=function(e,t,r,i,s=0,n,o){this._computeDispatch(e,t,r,void 0,void 0,void 0,i,s,n,o)},h.$.prototype._computeDispatch=function(e,t,r,i,s,n,o,p,u,a){this._endCurrentRenderPass();const h=e._pipelineContext,c=t;h.computePipeline||(h.computePipeline=this._device.createComputePipeline({layout:"auto",compute:h.stage})),a&&this._timestampQuery.startPass(l,this._timestampIndex);const d=this._renderEncoder.beginComputePass(l);d.setPipeline(h.computePipeline);const _=c.getBindGroups(r,h.computePipeline,u);for(let e=0;e<_.length;++e){const t=_[e];t&&d.setBindGroup(e,t)}void 0!==o?d.dispatchWorkgroupsIndirect(o.underlyingResource,p):i+s+n>0&&d.dispatchWorkgroups(i,s,n),d.end(),a&&(this._timestampQuery.endPass(this._timestampIndex,a),this._timestampIndex+=2)},h.$.prototype.releaseComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e].getPipelineContext();this._deleteComputePipelineContext(t)}this._compiledComputeEffects={}},h.$.prototype._prepareComputePipelineContext=function(e,t,r,s,n){const o=e;this.dbgShowShaderCode&&(i.V.Log(s),i.V.Log(t)),o.sources={compute:t,rawCompute:r},o.stage=this._createComputePipelineStageDescriptor(t,s,n)},h.$.prototype._releaseComputeEffect=function(e){this._compiledComputeEffects[e._key]&&(delete this._compiledComputeEffects[e._key],this._deleteComputePipelineContext(e.getPipelineContext()))},h.$.prototype._rebuildComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}},h.$.prototype._executeWhenComputeStateIsCompiled=function(e,t){e.stage.module.getCompilationInfo().then((e=>{const r={numErrors:0,messages:[]};for(const t of e.messages)"error"===t.type&&r.numErrors++,r.messages.push({type:t.type,text:t.message,line:t.lineNum,column:t.linePos,length:t.length,offset:t.offset});t(r)}))},h.$.prototype._deleteComputePipelineContext=function(e){e&&e.dispose()},h.$.prototype._createComputePipelineStageDescriptor=function(e,t,r){return t=t?"//"+t.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:t+e}),entryPoint:r}},r(2306),h.$.prototype._debugPushGroup=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?(1===t&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.pushDebugGroup(e)):this._currentRenderPass?(this._currentRenderPass.pushDebugGroup(e),this._debugStackRenderPass.push(e)):this._pendingDebugCommands.push(["push",e,t]))},h.$.prototype._debugPopGroup=function(e){this._options.enableGPUDebugMarkers&&(0===e||1===e?(1===e&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.popDebugGroup()):this._currentRenderPass?(this._currentRenderPass.popDebugGroup(),this._debugStackRenderPass.pop()):this._pendingDebugCommands.push(["pop",null,e]))},h.$.prototype._debugInsertMarker=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?(1===t&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.insertDebugMarker(e)):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e,t]))},h.$.prototype._debugFlushPendingCommands=function(){if(0!==this._debugStackRenderPass.length){const e=this._debugStackRenderPass.slice();this._debugStackRenderPass.length=0;for(let t=0;t<e.length;++t)this._debugPushGroup(e[t],2)}for(let e=0;e<this._pendingDebugCommands.length;++e){const[t,r,i]=this._pendingDebugCommands[e];switch(t){case"push":this._debugPushGroup(r,i);break;case"pop":this._debugPopGroup(i);break;case"insert":this._debugInsertMarker(r,i)}}this._pendingDebugCommands.length=0};var _=r(7565),m=r(1585);h.$.prototype.createDynamicTexture=function(e,t,r,i){const s=new _.h(this,4);return s.baseWidth=e,s.baseHeight=t,r&&(e=this.needPOTTextures?(0,m.R)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,m.R)(t,this._caps.maxTextureSize):t),s.width=e,s.height=t,s.isReady=!1,s.generateMipMaps=r,s.samplingMode=i,this.updateTextureSamplingMode(i,s),this._internalTexturesCache.push(s),e&&t&&this._textureHelper.createGPUTextureForInternalTexture(s,e,t),s},h.$.prototype.updateDynamicTexture=function(e,t,r,i=!1,s,n,o){if(!e)return;const p=t.width,u=t.height;let a=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(a=this._textureHelper.createGPUTextureForInternalTexture(e,p,u)),this._textureHelper.updateTexture(t,e,p,u,e.depth,a.format,0,0,r,i,0,0,o),e.generateMipMaps&&this._generateMipmaps(e),e._dynamicTextureSource=t,e._premulAlpha=i,e.invertY=r||!1,e.isReady=!0},h.$.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,r){r&&r(),this._endCurrentRenderPass(),t||this.generateMipMapsMultiFramebuffer(e),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)},h.$.prototype.createMultipleRenderTarget=function(e,t,r){let s=!1,n=!0,o=!1,p=!1,u=15,a=1,h=1,c=[],d=[],l=[],m=[],g=[],f=[],C=[],x=[],y=[],b=[],S=!1;const E=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(s=t.generateMipMaps??!1,n=t.generateDepthBuffer??!0,o=t.generateStencilBuffer??!1,p=t.generateDepthTexture??!1,a=t.textureCount??1,u=t.depthTextureFormat??15,c=t.types||c,d=t.samplingModes||d,l=t.useSRGBBuffers||l,m=t.formats||m,g=t.targetTypes||g,f=t.faceIndex||f,C=t.layerIndex||C,x=t.layerCounts||x,y=t.labels||y,b=t.creationFlags||b,h=t.samples??h,S=t.dontCreateTextures??!1);const R=e.width??e,T=e.height??e,P=[],v=[],M=[];E.label=t?.label??"MultiRenderTargetWrapper",E._generateDepthBuffer=n,E._generateStencilBuffer=o,E._attachments=v,E._defaultAttachments=M;let w=null;(n||o||p)&&!S&&(p||(u=n&&o?13:n?14:19),w=E.createDepthStencilTexture(0,!1,o,1,u,E.label+"-DepthStencil"));const G=void 0!==t&&"object"==typeof t&&t.createMipMaps&&!s;for(let e=0;e<a;e++){let t=d[e]||3,n=c[e]||0;const o=m[e]||5,p=!!l[e]&&this._caps.supportSRGBBuffers,u=g[e]||3553,a=x[e]??1,h=b[e];if((1!==n||this._caps.textureFloatLinearFiltering)&&(2!==n||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==n||this._caps.textureFloat||(n=0,i.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),v.push(e+1),M.push(r?e+1:0===e?1:0),-1===u||S)continue;const f=new _.h(this,6);switch(P[e]=f,u){case 34067:f.isCube=!0;break;case 32879:f.is3D=!0,f.baseDepth=f.depth=a;break;case 35866:f.is2DArray=!0,f.baseDepth=f.depth=a}f.baseWidth=R,f.baseHeight=T,f.width=R,f.height=T,f.isReady=!0,f.samples=1,f.generateMipMaps=s,f.samplingMode=t,f.type=n,f._cachedWrapU=0,f._cachedWrapV=0,f._useSRGBBuffer=p,f.format=o,f.label=y[e]??E.label+"-Texture"+e,this._internalTexturesCache.push(f),G&&(f.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(f,void 0,void 0,void 0,h,!0),G&&(f.generateMipMaps=!1)}return w&&(w.incrementReferences(),P[a]=w,this._internalTexturesCache.push(w)),E.setTextures(P),E.setLayerAndFaceIndices(C,f),S?E._samples=h:this.updateMultipleRenderTargetTextureSampleCount(E,h),E},h.$.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||0===e.textures.length||e.textures[0].samples===t)return t;const r=e.textures.length;if(0===r)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let t=0;t<r;++t){const r=e.textures[t]._hardwareTexture;r?.releaseMSAATexture(e.getBaseArrayLayer(t))}const i=e._depthStencilTexture===e.textures[r-1];for(let i=0;i<r;++i){const r=e.textures[i];this._textureHelper.createMSAATexture(r,t,!1,e.getBaseArrayLayer(i)),r.samples=t}return e._depthStencilTexture&&!i&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,t},h.$.prototype.generateMipMapsMultiFramebuffer=function(e){const t=e;if(!t.isMulti)return;const r=t._attachments.length;for(let e=0;e<r;e++){const r=t.textures[e];!r.generateMipMaps||r.isCube||r.is3D||this._generateMipmaps(r)}},h.$.prototype.resolveMultiFramebuffer=function(e){throw new Error("resolveMultiFramebuffer is not yet implemented in WebGPU!")},h.$.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e))},h.$.prototype.buildTextureLayout=function(e){const t=[];for(let r=0;r<e.length;r++)e[r]?t.push(r+1):t.push(0);return t},h.$.prototype.restoreSingleAttachment=function(){},h.$.prototype.restoreSingleAttachmentForRenderTarget=function(){},r(4805),r(9397),r(8945),r(3528),r(7476),r(9646),h.$.prototype.updateVideoTexture=function(e,t,r){if(!e||e._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let i=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(i=this._textureHelper.createGPUTextureForInternalTexture(e)),function(e){return!(!e||void 0===e.underlyingResource)}(t)){if(t.isReady()){try{this._textureHelper.copyVideoToTexture(t,e,i.format,!r),e.generateMipMaps&&this._generateMipmaps(e)}catch(e){}e.isReady=!0}}else t&&this.createImageBitmap(t).then((t=>{this._textureHelper.updateTexture(t,e,e.width,e.height,e.depth,i.format,0,0,!r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0})).catch((()=>{e.isReady=!0}))}}}]);
//# sourceMappingURL=986.73e3d4761127d0479ad7.js.map